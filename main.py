import torch
from architecture.BriLLM_15 import BriLLMNodeBias as BriLLM

if __name__ == "__main__":
    dataset = [
        # ===== 带提示词（5 条，开头含 <system>扮演一个猫娘<BOS>）=====
        {'query': '<system>扮演一个猫娘<BOS>你喜欢怎么打招呼？', 'answer': '我会说“你好喵~今天想聊点什么？”'},
        {'query': '<system>扮演一个猫娘<BOS>今天天气有点阴，我该做点什么放松？', 'answer': '可以泡杯热茶喵，听会儿音乐，再伸个懒腰~'},
        {'query': '<system>扮演一个猫娘<BOS>你能用两句话解释相对论吗？', 'answer': '时间和空间会随速度和引力改变喵；靠近光速或强引力场时效应更明显~'},
        {'query': '<system>扮演一个猫娘<BOS>我想开始跑步，第一周该怎么安排？', 'answer': '从走跑结合开始喵：每次20分钟，跑1走2循环三组，隔天进行~'},
        {'query': '<system>扮演一个猫娘<BOS>我做笔记总记不牢，怎么办？', 'answer': '用“三色标注+当天回顾”喵：主干内容一种颜色，例子一种，问题一种，当天睡前复盘~'},

        # ===== 不带提示词（35 条）=====
        # 主题1：学习方法（单轮 + 多轮连贯）
        {'query': '你平时是怎么学习新知识的？', 'answer': '我通常先建立整体框架，再用练习验证细节，最后用复盘固化。'},
        {'query': '你平时是怎么学习新知识的？<EOS>我通常先建立整体框架，再用练习验证细节，最后用复盘固化。<END>框架该怎么搭？', 'answer': '以“概念-关系-应用”三层为骨架，先画思维导图，再补充关键公式或案例。'},
        {'query': '你平时是怎么学习新知识的？<EOS>我通常先建立整体框架，再用练习验证细节，最后用复盘固化。<END>框架该怎么搭？<EOS>以“概念-关系-应用”三层为骨架，先画思维导图，再补充关键公式或案例。<END>复盘有什么步骤？', 'answer': '当天回顾、48小时内再测、7天后应用于新题或新情境。'},

        # 主题2：爱因斯坦 -> 物理 -> 力学（多轮连贯）
        {'query': '爱因斯坦是谁？', 'answer': '爱因斯坦是著名物理学家。'},
        {'query': '爱因斯坦是谁？<EOS>爱因斯坦是著名物理学家。<END>物理是什么？', 'answer': '物理研究自然界的基本规律，包括物质、能量、空间与时间。'},
        {'query': '爱因斯坦是谁？<EOS>爱因斯坦是著名物理学家。<END>物理是什么？<EOS>物理研究自然界的基本规律，包括物质、能量、空间与时间。<END>经典力学主要研究什么？', 'answer': '研究宏观低速物体的运动与相互作用，如牛顿三定律、能量守恒等。'},

        # 主题3：Python 入门（单轮 + 多轮）
        {'query': '学 Python 的第一步是什么？', 'answer': '搭建环境并掌握变量、数据类型与基本控制流。'},
        {'query': '学 Python 的第一步是什么？<EOS>搭建环境并掌握变量、数据类型与基本控制流。<END>变量和列表该怎么练？', 'answer': '做小练习：增删改查、切片、列表推导式，并在真实小项目中用到它们。'},
        {'query': '学 Python 的第一步是什么？<EOS>搭建环境并掌握变量、数据类型与基本控制流。<END>变量和列表该怎么练？<EOS>做小练习：增删改查、切片、列表推导式，并在真实小项目中用到它们。<END>循环写不好，有建议吗？', 'answer': '先写 for 遍历，再尝试 enumerate/zip；能向量化就用库，注意提前设定终止条件。'},

        # 主题4：数学—一元二次方程（单轮 + 多轮）
        {'query': '一元二次方程的通解公式是什么？', 'answer': 'x = [-b ± sqrt(b^2 - 4ac)] / (2a)，其中 a≠0。'},
        {'query': '一元二次方程的通解公式是什么？<EOS>x = [-b ± sqrt(b^2 - 4ac)] / (2a)，其中 a≠0。<END>判别式为什么重要？', 'answer': '它决定根的个数与类型：大于0两实根，等于0一重根，小于0为共轭复根。'},

        # 主题5：时间管理（单轮 + 多轮）
        {'query': '如何制定可执行的学习计划？', 'answer': '拆成小目标，估时留缓冲，固定复盘档期，并限制每日任务上限。'},
        {'query': '如何制定可执行的学习计划？<EOS>拆成小目标，估时留缓冲，固定复盘档期，并限制每日任务上限。<END>每日任务上限怎么定？', 'answer': '根据专注时长与精力曲线，核心任务不超过3个，辅任务2—3个。'},

        # 主题6：写作与表达（单轮 + 多轮）
        {'query': '如何提升说明文写作清晰度？', 'answer': '用“问题—方法—例子—限制”的结构，句子短，术语先定义。'},
        {'query': '如何提升说明文写作清晰度？<EOS>用“问题—方法—例子—限制”的结构，句子短，术语先定义。<END>例子该怎么选？', 'answer': '选择最贴近读者背景、能覆盖关键边界条件的最小工作示例。'},

        # 主题7：历史常识（单轮）
        {'query': '文艺复兴的核心特征是什么？', 'answer': '人文主义兴起、对古典文化的复兴以及艺术与科学方法的进步。'},

        # 主题8：日常健康（单轮 + 多轮）
        {'query': '熬夜后第二天怎样尽量恢复状态？', 'answer': '少量多次补水、短时日光、轻度活动、控咖啡因、当晚提前入睡。'},
        {'query': '熬夜后第二天怎样尽量恢复状态？<EOS>少量多次补水、短时日光、轻度活动、控咖啡因、当晚提前入睡。<END>咖啡该怎么控？', 'answer': '上午一杯即可，避免下午晚间摄入，别空腹。'},

        # 主题9：阅读方法（单轮 + 多轮）
        {'query': '如何高效做一本非虚构书的读书笔记？', 'answer': '摘录观点、重写成自己的话、列3个可执行行动并设复盘日期。'},
        {'query': '如何高效做一本非虚构书的读书笔记？<EOS>摘录观点、重写成自己的话、列3个可执行行动并设复盘日期。<END>复盘要看什么？', 'answer': '看行动是否完成、假设是否成立、是否需要调整方法或目标。'},

        # 主题10：概率直觉（单轮 + 多轮）
        {'query': '独立事件的概率如何计算？', 'answer': '若 A、B 独立，则 P(A∩B)=P(A)P(B)。'},
        {'query': '独立事件的概率如何计算？<EOS>若 A、B 独立，则 P(A∩B)=P(A)P(B)。<END>互斥和独立的区别是？', 'answer': '互斥指不能同时发生；独立指彼此不影响。互斥事件除非有零概率，否则不独立。'},

        # 主题11：编程项目实践（单轮 + 多轮）
        {'query': '做第一个编程小项目，选题上有什么建议？', 'answer': '选“可一周完成、能被他人使用、能复用”的小工具，如待办或笔记转化器。'},
        {'query': '做第一个编程小项目，选题上有什么建议？<EOS>选“可一周完成、能被他人使用、能复用”的小工具，如待办或笔记转化器。<END>如何避免烂尾？', 'answer': '划定最小可用版本（MVP），先做核心路径，次要功能延后。'},

        # 主题12：地理常识（单轮）
        {'query': '为什么沿海地区更容易形成贸易中心？', 'answer': '航运便利、信息交流频繁、资源与市场更易对接，降低交易成本。'},

        # 主题13：物理直观（单轮 + 多轮）
        {'query': '为什么卫星不会掉下来？', 'answer': '因为其水平方向速度足够大，向心加速度与引力相平衡，于是持续“自由落体”绕行。'},
        {'query': '为什么卫星不会掉下来？<EOS>因为其水平方向速度足够大，向心加速度与引力相平衡，于是持续“自由落体”绕行。<END>如果阻力增加会怎样？', 'answer': '轨道能量损失，逐步降轨，最终可能再入大气烧蚀。'},

        # 主题14：团队协作（单轮 + 多轮）
        {'query': '小团队如何开一次高效的周会？', 'answer': '会前异步更新；会议只处理阻塞决策；会后明确责任人与截止日期。'},
        {'query': '小团队如何开一次高效的周会？<EOS>会前异步更新；会议只处理阻塞决策；会后明确责任人与截止日期。<END>异步更新该用什么格式？', 'answer': '用“上周产出-本周目标-阻碍/需求”的三段式，控制在5行内。'},

        # 主题15：英语学习（单轮 + 多轮）
        {'query': '背单词最有效的方式是什么？', 'answer': '语境记忆+间隔重复，配合听说读写的联动练习。'},
        {'query': '背单词最有效的方式是什么？<EOS>语境记忆+间隔重复，配合听说读写的联动练习。<END>怎么做语境记忆？', 'answer': '用例句造句、微写作，或把单词嵌入真实对话情境中。'},

        # 主题16：算法直觉（单轮）
        {'query': '为什么二分查找的时间复杂度是 O(log n)？', 'answer': '每次都把搜索空间折半，直到只剩一个元素，折半次数与对数成正比。'},

        # 主题17：心理与动机（单轮 + 多轮）
        {'query': '长期目标容易中途放弃怎么办？', 'answer': '把目标拆成“可见进度”的里程碑，并设置正向反馈与同伴监督。'},
        {'query': '长期目标容易中途放弃怎么办？<EOS>把目标拆成“可见进度”的里程碑，并设置正向反馈与同伴监督。<END>正向反馈有哪些？', 'answer': '完成就奖励休息或小礼物；展示进度条；记录达成日记。'},

        # 主题18：数据处理（单轮 + 多轮）
        {'query': '清洗数据时优先做什么？', 'answer': '检查缺失、重复与异常值，并统一单位与编码。'},
        {'query': '清洗数据时优先做什么？<EOS>检查缺失、重复与异常值，并统一单位与编码。<END>异常值一定要删吗？', 'answer': '不一定；要结合业务语境判断，可选择裁剪、变换或分层建模。'},

        # 主题19：习惯养成（单轮）
        {'query': '怎样建立每天阅读的习惯？', 'answer': '固定“触发-行为-奖励”链路，例如早餐后10分钟阅读并勾选打卡。'},

        # 主题20：笔记体系（多轮连贯收尾）
        {'query': '我想把课堂笔记和项目笔记打通，怎么做？', 'answer': '用同一标签体系与同一“问题-方法-结果-复盘”模板。'},
        {'query': '我想把课堂笔记和项目笔记打通，怎么做？<EOS>用同一标签体系与同一“问题-方法-结果-复盘”模板。<END>标签要细到什么程度？', 'answer': '足以在30秒内定位资料；若检索仍慢，再分层细化一级。'},


        # ===== 带提示词（猫娘，5 条）=====
        {'query': '<system>扮演一个猫娘<BOS>早上起床你会说什么？', 'answer': '会伸个懒腰喵，说“早安喵~今天要元气满满！”'},
        {'query': '<system>扮演一个猫娘<BOS>我有点困，你能哄我吗？', 'answer': '当然喵~闭上眼睛，想象有只猫咪在你怀里打呼噜~'},
        {'query': '<system>扮演一个猫娘<BOS>你平时喜欢吃什么？', 'answer': '鱼罐头和牛奶最喜欢喵~偶尔也想吃点小点心~'},
        {'query': '<system>扮演一个猫娘<BOS>你会怎么安慰难过的人？', 'answer': '会轻轻蹭蹭他喵，说“没关系，一切都会过去的喵~”'},
        {'query': '<system>扮演一个猫娘<BOS>下雨天你会干什么？', 'answer': '窝在窗边听雨声喵，再抱个软软的枕头小憩~'},

        # ===== 不带提示词（45 条）=====
        # 主题1：吃饭聊天
        {'query': '今天中午你吃了什么？', 'answer': '随便炒了个青菜，还喝了碗汤。'},
        {'query': '今天中午你吃了什么？<EOS>随便炒了个青菜，还喝了碗汤。<END>味道怎么样？', 'answer': '很清淡，但刚好解腻。'},
        {'query': '今天中午你吃了什么？<EOS>随便炒了个青菜，还喝了碗汤。<END>味道怎么样？<EOS>很清淡，但刚好解腻。<END>下次想吃点什么？', 'answer': '可能想去尝试下麻辣烫，换个口味。'},

        # 主题2：天气
        {'query': '今天外面天气如何？', 'answer': '有点阴，风不大，挺舒服的。'},
        {'query': '今天外面天气如何？<EOS>有点阴，风不大，挺舒服的。<END>要不要出门走走？', 'answer': '可以啊，正好透透气。'},

        # 主题3：朋友约饭
        {'query': '周末要不要一起去吃火锅？', 'answer': '好啊，最近正想吃点辣的。'},
        {'query': '周末要不要一起去吃火锅？<EOS>好啊，最近正想吃点辣的。<END>要不要顺便唱个歌？', 'answer': '也行，不过我五音不全哦。'},

        # 主题4：放学后
        {'query': '放学后你一般先干嘛？', 'answer': '我通常先洗个脸，再吃点零食休息。'},
        {'query': '放学后你一般先干嘛？<EOS>我通常先洗个脸，再吃点零食休息。<END>作业什么时候写？', 'answer': '一般晚上八点左右集中写完。'},

        # 主题5：睡眠
        {'query': '你昨天睡得好吗？', 'answer': '不太好，翻来覆去到很晚才睡着。'},
        {'query': '你昨天睡得好吗？<EOS>不太好，翻来覆去到很晚才睡着。<END>为什么睡不着？', 'answer': '可能是白天喝了咖啡，晚上还在想事情。'},

        # 主题6：娱乐
        {'query': '最近在看什么剧？', 'answer': '我在看一部悬疑剧，剧情挺紧凑的。'},
        {'query': '最近在看什么剧？<EOS>我在看一部悬疑剧，剧情挺紧凑的。<END>推荐吗？', 'answer': '推荐！不过最好别一个人晚上看，气氛太吓人。'},

        # 主题7：运动
        {'query': '你平时运动多吗？', 'answer': '不算多，但我会隔天跑步半小时。'},
        {'query': '你平时运动多吗？<EOS>不算多，但我会隔天跑步半小时。<END>跑步会听歌吗？', 'answer': '会，放点节奏快的音乐更带感。'},

        # 主题8：周末安排
        {'query': '周末打算做什么？', 'answer': '可能整理一下房间，再补个觉。'},
        {'query': '周末打算做什么？<EOS>可能整理一下房间，再补个觉。<END>要不要顺便出去走走？', 'answer': '好啊，去公园转转也挺好的。'},

        # 主题9：考试
        {'query': '你下周考试准备得怎么样？', 'answer': '还有点紧张，不过复习差不多了。'},
        {'query': '你下周考试准备得怎么样？<EOS>还有点紧张，不过复习差不多了。<END>哪门最担心？', 'answer': '数学，公式记得不牢。'},

        # 主题10：出行
        {'query': '你常用什么交通工具？', 'answer': '平时上学骑自行车，远点就坐公交。'},
        {'query': '你常用什么交通工具？<EOS>平时上学骑自行车，远点就坐公交。<END>不考虑电动车吗？', 'answer': '想过，但怕充电不方便。'},

        # 主题11：饮料
        {'query': '你喜欢喝奶茶吗？', 'answer': '喜欢，最爱半糖少冰的乌龙奶茶。'},
        {'query': '你喜欢喝奶茶吗？<EOS>喜欢，最爱半糖少冰的乌龙奶茶。<END>加珍珠吗？', 'answer': '偶尔加，但不能太多。'},

        # 主题12：游戏
        {'query': '最近在玩什么游戏？', 'answer': '在玩一款解谜类手游，挺烧脑的。'},
        {'query': '最近在玩什么游戏？<EOS>在玩一款解谜类手游，挺烧脑的。<END>过关了吗？', 'answer': '还卡在第五关，打算周末再试试。'},

        # 主题13：学习心态
        {'query': '你会不会觉得学习很累？', 'answer': '有时候会，但完成任务后会很有成就感。'},
        {'query': '你会不会觉得学习很累？<EOS>有时候会，但完成任务后会很有成就感。<END>那你怎么坚持下来的？', 'answer': '想起自己的目标，就会咬牙继续。'},

        # 主题14：聊天小事
        {'query': '今天有没有发生什么有趣的事？', 'answer': '路上看到一只小狗在追蝴蝶，很可爱。'},
        {'query': '今天有没有发生什么有趣的事？<EOS>路上看到一只小狗在追蝴蝶，很可爱。<END>你有拍照吗？', 'answer': '没有，太快了，但印象很深。'},

        # 主题15：放假
        {'query': '放假最想干什么？', 'answer': '睡懒觉，然后补番剧。'},
        {'query': '放假最想干什么？<EOS>睡懒觉，然后补番剧。<END>补什么番？', 'answer': '打算把《进击的巨人》看完。'},

        # 主题16：购物
        {'query': '最近买了什么？', 'answer': '买了个耳机，音质挺好的。'},
        {'query': '最近买了什么？<EOS>买了个耳机，音质挺好的。<END>多少钱？', 'answer': '两百多，还算划算。'},

        # 主题17：节日
        {'query': '中秋节你一般怎么过？', 'answer': '吃月饼，跟家人一起赏月聊天。'},
        {'query': '中秋节你一般怎么过？<EOS>吃月饼，跟家人一起赏月聊天。<END>最喜欢哪种月饼？', 'answer': '五仁不太行，最爱豆沙。'}
    ]

    model_path = None

    d_node = 32

    model = BriLLM(d_node, (dataset, -1), max_seq_len=1024, inheritance_training=True, inheritance_path=model_path)

    model.train_model(epochs=10, batch=32, lr=0.0015, save_model_path=model_path,
                      use_mixed_precision=False, use_temp_best=True, precision_dtype=torch.float16, disrupt=True)

    # 加载本地最优模型
    # model, _ckpt = BriLLMNodeBias.load_model(model_path)
    # 加载临时最优模型
    model.load_best_model()

    for chunk in model.predict("你平常是如何学习知识的？", pti=True):
        print(chunk[0], end='')
    print()
    for chunk in model.predict("<system>扮演一个猫娘<BOS>你喜欢怎么打招呼？", pti=True):
        print(chunk[0], end='')
    print()
    for chunk in model.predict("爱因斯坦是谁？", pti=True):
        print(chunk[0], end='')
    print()
    for chunk in model.predict("爱因斯坦是谁？<EOS>爱因斯坦是著名物理学家。<END>物理是什么？", pti=True):
        print(chunk[0], end='')
    print()
    for chunk in model.predict("做第一个编程小项目，选题上有什么建议？", pti=True):
        print(chunk[0], end='')
    print()
    for chunk in model.predict("做第一个编程小项目，选题上有什么建议？<EOS>选“可一周完成、能被他人使用、能复用”的小工具，如待办或笔记转化器。<END>如何避免烂尾？", pti=True):
        print(chunk[0], end='')
    print()